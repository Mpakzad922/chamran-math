<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¹Ù…Ù„ÛŒØ§Øª Ú©Ø³Ø±Ù‡Ø§ - Ú©Ù„Ø§Ø³ Ø´Ù‡ÛŒØ¯ Ú†Ù…Ø±Ø§Ù†</title>
    
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/lalezar-font@v32.0/dist/lalezar-font-face.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />

    <style>
        :root { --primary: #00f2ff; --bg: #050510; --accent: #ff0055; }
        body { margin: 0; overflow: hidden; background: var(--bg); color: #fff; font-family: 'Lalezar'; touch-action: none; user-select: none; }
        
        /* Ù…Ø¯ÛŒØ±ÛŒØª ØµÙØ­Ø§Øª */
        .screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; background: var(--bg); transition: opacity 0.5s;
        }
        .active { display: flex; }

        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ */
        h1 { margin: 0; font-size: 2.5rem; text-shadow: 0 0 20px var(--primary); color: var(--primary); text-align: center;}
        p { font-family: 'Vazirmatn'; color: #aaa; margin-top: 10px; text-align: center;}

        /* ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ */
        .login-box {
            background: rgba(255,255,255,0.05); padding: 30px; border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1); width: 80%; max-width: 350px;
            text-align: center; backdrop-filter: blur(10px);
        }
        input {
            width: 100%; padding: 15px; margin: 20px 0; border-radius: 50px;
            border: 2px solid #333; background: #000; color: #fff;
            font-family: 'Vazirmatn'; text-align: center; font-size: 1.1rem; outline: none;
            box-sizing: border-box; transition: 0.3s;
        }
        input:focus { border-color: var(--primary); box-shadow: 0 0 15px rgba(0, 242, 255, 0.3); }
        
        button {
            padding: 15px 40px; border-radius: 50px; border: none;
            font-family: 'Lalezar'; font-size: 1.4rem; cursor: pointer;
            background: linear-gradient(45deg, var(--primary), #0066ff); color: #000;
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.4); transition: transform 0.2s;
            width: 100%;
        }
        button:active { transform: scale(0.95); }

        /* ØµÙØ­Ù‡ Ù‚ÙÙ„ (Ø¨Ø§Ø²Ú¯Ø´Øª Ù…Ø¬Ø¯Ø¯) */
        .lock-card {
            border: 2px solid var(--accent);
            box-shadow: 0 0 30px rgba(255, 0, 85, 0.2);
        }
        .student-name { color: #fff; font-size: 1.8rem; margin: 10px 0; display: block; }
        .cool-msg { color: var(--primary); font-size: 1.2rem; margin-top: 20px; line-height: 1.6; }

        /* Ù…Ø­ÛŒØ· Ø¨Ø§Ø²ÛŒ */
        #game-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: flex; flex-direction: column; align-items: center; }
        
        .hud-top {
            margin-top: 60px; background: rgba(255,255,255,0.1); padding: 10px 30px;
            border-radius: 20px; backdrop-filter: blur(5px); pointer-events: auto;
            display: flex; gap: 20px; align-items: center; border: 1px solid rgba(255,255,255,0.2);
        }
        
        .math-problem { font-size: 2.2rem; direction: ltr; display: flex; align-items: center; gap: 10px; color: #ffeb3b; }
        .fraction { display: inline-flex; flex-direction: column; align-items: center; font-size: 0.8em; line-height: 1; }
        .frac-line { width: 100%; height: 2px; background: currentColor; margin: 3px 0; }

        #btn-shoot {
            position: absolute; bottom: 40px; width: 200px;
            background: #00e676; box-shadow: 0 0 20px #00e676;
            opacity: 0; transform: scale(0); pointer-events: auto;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #btn-shoot.show { opacity: 1; transform: scale(1); }

        .feedback {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
            font-size: 5rem; text-shadow: 0 0 30px #fff; display: none; z-index: 50;
        }

        /* Ù„ÙˆÚ¯Ùˆ Ú©Ù„Ø§Ø³ */
        .badge {
            position: absolute; top: 15px; right: 15px;
            background: rgba(0,0,0,0.7); padding: 5px 15px; border-radius: 20px;
            border: 1px solid var(--accent); display: flex; align-items: center; gap: 8px;
            z-index: 20;
        }

    </style>
</head>
<body>

    <canvas id="bgCanvas" style="position:absolute; top:0; left:0; z-index:0;"></canvas>
    <canvas id="gameCanvas" style="position:absolute; top:0; left:0; z-index:1;"></canvas>

    <div id="login-screen" class="screen">
        <div class="login-box">
            <h1>Ù¾Ø§ÛŒÚ¯Ø§Ù‡ ÙØ¶Ø§ÛŒÛŒ<br><span style="font-size:0.6em; color:#fff;">Ú©Ù„Ø§Ø³ Ø´Ù‡ÛŒØ¯ Ú†Ù…Ø±Ø§Ù†</span></h1>
            <p>Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø¹Ù…Ù„ÛŒØ§ØªØŒ Ù‡ÙˆÛŒØª Ø®ÙˆØ¯ Ø±Ø§ ØªØ§ÛŒÛŒØ¯ Ú©Ù†ÛŒØ¯.</p>
            <input type="text" id="inpName" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ..." autocomplete="off">
            <button onclick="attemptLogin()">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¹Ù…Ù„ÛŒØ§Øª</button>
        </div>
    </div>

    <div id="lock-screen" class="screen">
        <div class="login-box lock-card">
            <div style="font-size:4rem; margin-bottom:10px;">ğŸ«¡</div>
            <span class="student-name" id="lockName">Ù†Ø§Ù… Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</span>
            <div class="cool-msg" id="lockMsg">
                Ù…Ø§Ù…ÙˆØ±ÛŒØª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯Ù‡ Ø§Ø³ØªØŒ Ú©Ø§Ù¾ÛŒØªØ§Ù†!
                <br>
                <span style="font-size:0.9rem; color:#aaa;">(Ù†ØªÛŒØ¬Ù‡ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª)</span>
            </div>
        </div>
    </div>

    <div id="game-ui" style="display:none;">
        <div class="badge">
            <span>ğŸš€</span> <span style="font-family:'Vazirmatn'; font-size:0.8rem;">Ú©Ù„Ø§Ø³ Ù¾Ù†Ø¬Ù…</span>
        </div>

        <div class="hud-top">
            <span id="scoreEl">Ø§Ù…ØªÛŒØ§Ø²: Û°</span>
            <div style="width:1px; height:20px; background:#fff;"></div>
            <div id="problemEl" class="math-problem"></div>
        </div>

        <div id="feedback" class="feedback"></div>
        <button id="btn-shoot">Ø´Ú©Ø§Ø±Ø´ Ú©Ù†!</button>
    </div>

    <div id="result-screen" class="screen">
        <div class="login-box" style="border-color:#00e676; box-shadow:0 0 30px rgba(0,230,118,0.2);">
            <h1 style="color:#00e676;">Ù…Ø§Ù…ÙˆØ±ÛŒØª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯!</h1>
            <p style="margin:20px 0; font-size:1.2rem; color:#fff;">Ø§Ù…ØªÛŒØ§Ø² Ù†Ù‡Ø§ÛŒÛŒ Ø´Ù…Ø§:</p>
            <h2 style="font-size:3rem; margin:0; color:#ffeb3b;" id="finalScore">Û°</h2>
            <p style="margin-top:30px; font-size:0.9rem;">Ø§Ø² ØµÙØ­Ù‡ Ø§Ø³Ú©Ø±ÛŒÙ†â€ŒØ´Ø§Øª Ø¨Ú¯ÛŒØ±ÛŒØ¯.</p>
        </div>
    </div>

    <script>
        // --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ ---
        const DB_KEY = 'chamran_class_mission_data_v1';

        // --- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ---
        const toPersianNum = (n) => n.toString().replace(/\d/g, x => "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹"[x]);
        const $ = (id) => document.getElementById(id);

        // --- Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø± (Ø§ÙˆÙ„ÛŒÙ† Ú©Ø§Ø±ÛŒ Ú©Ù‡ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯) ---
        function checkUserStatus() {
            const savedData = localStorage.getItem(DB_KEY);
            
            if (savedData) {
                // Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§ Ø¨Ø§Ø²ÛŒ Ú©Ø±Ø¯Ù‡
                const data = JSON.parse(savedData);
                showLockedScreen(data.name);
            } else {
                // Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø§Ø³Øª
                $('login-screen').classList.add('active');
            }
        }

        function showLockedScreen(name) {
            $('lockName').innerText = name;
            // Ø§Ù†ØªØ®Ø§Ø¨ Ù¾ÛŒØ§Ù… ØªØµØ§Ø¯ÙÛŒ
            const msgs = [
                "Ù…Ø§Ù…ÙˆØ±ÛŒØª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³ØªØŒ Ú©Ø§Ù¾ÛŒØªØ§Ù†!",
                "Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¹Ù…Ù„ÛŒØ§Øª Ø´Ù…Ø§ Ø¯Ø± Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª. Ø®Ø³ØªÙ‡ Ù†Ø¨Ø§Ø´ÛŒØ¯!",
                "Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø± Ø§ÛŒÙ† Ú†Ø§Ù„Ø´ Ø´Ø±Ú©Øª Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯. Ø¹Ø§Ù„ÛŒ Ø¨ÙˆØ¯!",
                "Ø³ÛŒØ³ØªÙ… Ø§Ù…Ù†ÛŒØªÛŒ: ÙˆØ±ÙˆØ¯ Ù…Ø¬Ø¯Ø¯ Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª. Ù†ØªÛŒØ¬Ù‡ Ø´Ù…Ø§ Ù…Ø­ÙÙˆØ¸ Ø§Ø³Øª."
            ];
            $('lockMsg').innerHTML = msgs[Math.floor(Math.random() * msgs.length)] + '<br><br><span style="font-size:0.8rem; color:#666;">(ÙˆØ±ÙˆØ¯ Ù…Ø¬Ø¯Ø¯ Ù…Ø³Ø¯ÙˆØ¯ Ø§Ø³Øª)</span>';
            
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            $('lock-screen').classList.add('active');
        }

        // --- Ù„Ø§Ø¬ÛŒÚ© ÙˆØ±ÙˆØ¯ ---
        let playerName = "";
        
        function attemptLogin() {
            const name = $('inpName').value.trim();
            if (name.length < 3) {
                alert("Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ú©Ø§Ù…Ù„ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯.");
                return;
            }
            playerName = name;
            
            // Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ
            $('login-screen').classList.remove('active');
            $('game-ui').style.display = 'flex';
            initGame();
        }

        // --- Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ Ùˆ Ø°Ø®ÛŒØ±Ù‡ ---
        function finishGame() {
            // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡
            const data = {
                name: playerName,
                score: score,
                date: new Date().toISOString(),
                played: true
            };
            localStorage.setItem(DB_KEY, JSON.stringify(data));

            // Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ù†Ø§Ù…Ù‡
            $('finalScore').innerText = toPersianNum(score);
            $('game-ui').style.display = 'none';
            $('result-screen').classList.add('active');
        }

        // ==========================================
        // ========== Ù…ÙˆØªÙˆØ± Ø¨Ø§Ø²ÛŒ (Game Engine) =======
        // ==========================================
        
        const canvas = $('gameCanvas');
        const ctx = canvas.getContext('2d');
        const bgCanvas = $('bgCanvas');
        const bgCtx = bgCanvas.getContext('2d');
        let width, height;

        const resize = () => {
            width = window.innerWidth; height = window.innerHeight;
            canvas.width = bgCanvas.width = width; canvas.height = bgCanvas.height = height;
        };
        window.addEventListener('resize', resize); resize();

        let orbs = [], particles = [], stars = [], score = 0;
        let currentProblem = {}, questionCount = 0;
        const MAX_Q = 5; // ØªØ¹Ø¯Ø§Ø¯ Ø³ÙˆØ§Ù„Ø§Øª

        // Ø³ØªØ§Ø±Ù‡â€ŒÙ‡Ø§
        class Star {
            constructor() { this.x=Math.random()*width; this.y=Math.random()*height; this.s=Math.random()*2; }
            draw() { bgCtx.fillStyle=`rgba(255,255,255,${Math.random()})`; bgCtx.beginPath(); bgCtx.arc(this.x,this.y,this.s,0,6.28); bgCtx.fill(); }
        }

        // Ú¯ÙˆÛŒâ€ŒÙ‡Ø§
        class Orb {
            constructor(x, y) {
                this.x=x; this.y=y; this.r=0; this.tr=width<600?28:35;
                this.vx=(Math.random()-0.5)*2; this.vy=(Math.random()-0.5)*2; this.sel=false;
            }
            update() {
                this.x+=this.vx; this.y+=this.vy;
                if(this.x<this.tr || this.x>width-this.tr) this.vx*=-1;
                if(this.y<this.tr+100 || this.y>height-this.tr-80) this.vy*=-1;
                if(this.r<this.tr) this.r+=2;
            }
            draw() {
                ctx.beginPath(); ctx.arc(this.x, this.y, this.r, 0, 6.28);
                ctx.fillStyle = this.sel ? '#ffd700' : 'rgba(0, 242, 255, 0.2)';
                ctx.fill(); 
                ctx.lineWidth=2; ctx.strokeStyle= this.sel ? '#fff' : 'rgba(0, 242, 255, 0.8)'; 
                ctx.stroke();
                if(this.sel) { ctx.shadowBlur=20; ctx.shadowColor='#ffd700'; } else { ctx.shadowBlur=0; }
            }
        }

        // Ø°Ø±Ø§Øª
        class Part {
            constructor(x,y,c) { this.x=x; this.y=y; this.c=c; this.vx=(Math.random()-0.5)*10; this.vy=(Math.random()-0.5)*10; this.l=1; }
            up() { this.x+=this.vx; this.y+=this.vy; this.l-=0.05; }
            dr() { ctx.globalAlpha=this.l; ctx.fillStyle=this.c; ctx.beginPath(); ctx.arc(this.x,this.y,4,0,6.28); ctx.fill(); ctx.globalAlpha=1; }
        }

        function initGame() {
            for(let i=0; i<80; i++) stars.push(new Star());
            generateProblem();
            loop();
        }

        function generateProblem() {
            if(questionCount >= MAX_Q) { finishGame(); return; }
            questionCount++;

            // ØªÙˆÙ„ÛŒØ¯ Ø³ÙˆØ§Ù„
            const denoms = [2, 3, 4, 5];
            const denom = denoms[Math.floor(Math.random()*denoms.length)];
            const num = Math.floor(Math.random()*(denom-1))+1;
            const whole = denom * (Math.floor(Math.random()*2)+1); // ØªØ¹Ø¯Ø§Ø¯ Ú©Ù… Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„
            const ans = (whole/denom)*num;
            currentProblem = { ans };

            // Ù†Ù…Ø§ÛŒØ´
            const pEl = $('problemEl');
            const fHTML = `<div class="fraction"><span>${toPersianNum(num)}</span><div class="frac-line"></div><span>${toPersianNum(denom)}</span></div>`;
            const wHTML = `<span>${toPersianNum(whole)}</span>`;
            
            if(Math.random()>0.5) pEl.innerHTML = `${fHTML} <span>Ã—</span> ${wHTML} <span>=</span> ?`;
            else pEl.innerHTML = `${wHTML} <span>Ã—</span> ${fHTML} <span>=</span> ?`;

            $('btn-shoot').classList.remove('show');
            
            // ØªÙˆÙ„ÛŒØ¯ Ú¯ÙˆÛŒ
            orbs = [];
            for(let i=0; i<whole; i++) orbs.push(new Orb(width/2, height/2));
        }

        function checkAnswer() {
            const sel = orbs.filter(o=>o.sel).length;
            const fb = $('feedback');
            
            if(sel === currentProblem.ans) {
                score += 20;
                $('scoreEl').innerText = `Ø§Ù…ØªÛŒØ§Ø²: ${toPersianNum(score)}`;
                fb.innerText = "âœ…"; fb.style.color = "#00e676"; fb.style.display="block";
                
                // Ø§Ù†ÙØ¬Ø§Ø±
                orbs.forEach(o=>{ if(o.sel) for(let k=0;k<8;k++) particles.push(new Part(o.x,o.y,'#ffd700')); });
                orbs = [];
                
                setTimeout(()=>{ fb.style.display="none"; generateProblem(); }, 1500);
            } else {
                fb.innerText = "âŒ"; fb.style.color = "#ff1744"; fb.style.display="block";
                setTimeout(()=>{ fb.style.display="none"; }, 1000);
            }
        }

        function loop() {
            bgCtx.clearRect(0,0,width,height);
            stars.forEach(s=>s.draw());
            
            ctx.clearRect(0,0,width,height);
            
            // Ø®Ø·ÙˆØ·
            const sels = orbs.filter(o=>o.sel);
            ctx.beginPath(); ctx.strokeStyle='rgba(255,235,59,0.5)'; ctx.lineWidth=2;
            for(let i=0; i<sels.length; i++) for(let j=i+1; j<sels.length; j++) {
                if(Math.hypot(sels[i].x-sels[j].x, sels[i].y-sels[j].y)<250) {
                    ctx.moveTo(sels[i].x, sels[i].y); ctx.lineTo(sels[j].x, sels[j].y);
                }
            }
            ctx.stroke();

            orbs.forEach(o=>{ o.update(); o.draw(); });
            particles.forEach((p,i)=>{ p.up(); p.dr(); if(p.l<=0) particles.splice(i,1); });
            
            requestAnimationFrame(loop);
        }

        // ÙˆØ±ÙˆØ¯ÛŒ
        function handle(x,y) {
            let ch = false;
            orbs.forEach(o=>{
                if(Math.hypot(x-o.x, y-o.y) < o.tr+15) { o.sel=!o.sel; ch=true; for(let k=0;k<3;k++) particles.push(new Part(o.x,o.y,'#fff')); }
            });
            if(ch) {
                const c = orbs.filter(o=>o.sel).length;
                const b = $('btn-shoot');
                if(c>0) { b.classList.add('show'); b.innerText=`Ø´Ú©Ø§Ø± ${toPersianNum(c)} Ù‡Ø¯Ù`; }
                else b.classList.remove('show');
            }
        }
        canvas.addEventListener('mousedown', e=>handle(e.clientX, e.clientY));
        canvas.addEventListener('touchstart', e=>{ e.preventDefault(); handle(e.changedTouches[0].clientX, e.changedTouches[0].clientY); }, {passive:false});
        $('btn-shoot').addEventListener('click', checkAnswer);
        $('btn-shoot').addEventListener('touchstart', (e)=>{ e.preventDefault(); checkAnswer(); });

        // Ø§Ø¬Ø±Ø§ÛŒ Ú†Ú©
        checkUserStatus();

    </script>
</body>
</html>