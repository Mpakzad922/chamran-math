<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¢Ø²Ù…ÙˆÙ† Ø±ÛŒØ§Ø¶ÛŒ Ú†Ù…Ø±Ø§Ù† (ØªØ§ÛŒÙ…Ø±Ø¯Ø§Ø±)</title>
    
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/lalezar-font@v32.0/dist/lalezar-font-face.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />

    <style>
        :root { --primary: #00f2ff; --bg: #050510; --accent: #ff0055; --success: #00e676; }
        body { margin: 0; overflow: hidden; background: var(--bg); color: #fff; font-family: 'Lalezar'; touch-action: none; user-select: none; }
        
        .screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; background: var(--bg); transition: opacity 0.5s;
        }
        .active { display: flex; }

        /* Ø¨Ø§Ú©Ø³â€ŒÙ‡Ø§ */
        .box-card {
            background: rgba(255,255,255,0.05); padding: 30px; border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1); width: 85%; max-width: 350px;
            text-align: center; backdrop-filter: blur(10px); box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        
        /* ÙˆØ±ÙˆØ¯ÛŒ Ùˆ Ø¯Ú©Ù…Ù‡ */
        input {
            width: 100%; padding: 15px; margin: 20px 0; border-radius: 50px;
            border: 2px solid #333; background: #000; color: #fff;
            font-family: 'Vazirmatn'; text-align: center; font-size: 1.1rem; outline: none;
        }
        button {
            padding: 15px; border-radius: 50px; border: none; width: 100%;
            font-family: 'Lalezar'; font-size: 1.4rem; cursor: pointer;
            background: linear-gradient(45deg, var(--primary), #0066ff); color: #000;
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.4); transition: transform 0.1s;
        }
        button:active { transform: scale(0.95); }

        /* Ú©Ø§Ø±Ù†Ø§Ù…Ù‡ */
        .report-row {
            display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 10px 0; margin-bottom: 5px;
        }
        .report-label { font-family: 'Vazirmatn'; color: #aaa; font-size: 0.9rem; }
        .report-val { font-family: 'Vazirmatn'; color: #fff; font-size: 1rem; }
        .score-big { font-size: 3.5rem; color: var(--success); margin: 10px 0; text-shadow: 0 0 20px rgba(0,230,118,0.4); }

        /* ØªØ§ÛŒÙ…Ø± */
        .timer-box {
            position: absolute; top: 15px; left: 15px; z-index: 20;
            font-family: 'Vazirmatn'; font-weight: bold; font-size: 1.2rem;
            background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px;
            border: 1px solid var(--primary); color: var(--primary);
            display: flex; align-items: center; gap: 5px;
        }
        .timer-icon { animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ (Ø¢ÙØ±ÛŒÙ†) */
        .feedback-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            pointer-events: none; z-index: 50; text-align: center;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .feedback-overlay.show { transform: translate(-50%, -50%) scale(1); }
        .fb-text { font-size: 4rem; text-shadow: 0 0 30px #000; display: block; }
        .fb-sub { font-family: 'Vazirmatn'; font-size: 1rem; background: rgba(0,0,0,0.7); padding: 5px 15px; border-radius: 20px; }

        /* Ù…Ø­ÛŒØ· Ø¨Ø§Ø²ÛŒ */
        #game-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: flex; flex-direction: column; align-items: center; }
        .hud-top { margin-top: 70px; background: rgba(255,255,255,0.1); padding: 5px 25px; border-radius: 20px; backdrop-filter: blur(5px); pointer-events: auto; display: flex; gap: 20px; align-items: center; border: 1px solid rgba(255,255,255,0.2); }
        .math-problem { font-size: 2.2rem; direction: ltr; display: flex; align-items: center; gap: 10px; color: #ffeb3b; }
        .fraction { display: inline-flex; flex-direction: column; align-items: center; font-size: 0.8em; line-height: 1; }
        .frac-line { width: 100%; height: 2px; background: currentColor; margin: 3px 0; }
        #btn-shoot { position: absolute; bottom: 40px; width: 200px; background: var(--success); box-shadow: 0 0 20px var(--success); opacity: 0; transform: scale(0); pointer-events: auto; transition: all 0.3s; }
        #btn-shoot.show { opacity: 1; transform: scale(1); }
        .badge { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.7); padding: 5px 15px; border-radius: 20px; border: 1px solid var(--accent); display: flex; align-items: center; gap: 8px; z-index: 20; }

        /* Ø¯Ú©Ù…Ù‡ Ù…Ø®ÙÛŒ Ù…Ø¹Ù„Ù… */
        .admin-btn { margin-top: 20px; background: transparent; border: 1px solid #333; color: #444; font-size: 0.8rem; padding: 5px 10px; width: auto; box-shadow: none; }

    </style>
</head>
<body>

    <canvas id="bgCanvas" style="position:absolute; top:0; left:0; z-index:0;"></canvas>
    <canvas id="gameCanvas" style="position:absolute; top:0; left:0; z-index:1;"></canvas>

    <div id="login-screen" class="screen">
        <div class="box-card">
            <h1 style="margin:0; color:var(--primary);">Ú©Ù„Ø§Ø³ Ø´Ù‡ÛŒØ¯ Ú†Ù…Ø±Ø§Ù†</h1>
            <p style="font-family:'Vazirmatn'; font-size:0.9rem;">Ø¢Ø²Ù…ÙˆÙ† Ø±ÛŒØ§Ø¶ÛŒ (Ø²Ù…Ø§Ù†: Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡)</p>
            <input type="text" id="inpName" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ..." autocomplete="off">
            <button onclick="attemptLogin()">Ø´Ø±ÙˆØ¹ Ø¢Ø²Ù…ÙˆÙ†</button>
        </div>
    </div>

    <div id="result-screen" class="screen">
        <div class="box-card" style="border-color:var(--success);">
            <div style="font-size:3rem; margin-bottom:10px;">ğŸ“‹</div>
            <h2 style="margin:0; color:#fff;">Ú©Ø§Ø±Ù†Ø§Ù…Ù‡ Ø¹Ù…Ù„Ú©Ø±Ø¯</h2>
            
            <div style="margin: 20px 0;">
                <div class="report-row">
                    <span class="report-label">Ù†Ø§Ù… Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²:</span>
                    <span class="report-val" id="resName">-</span>
                </div>
                <div class="report-row">
                    <span class="report-label">ØªØ§Ø±ÛŒØ® Ø¢Ø²Ù…ÙˆÙ†:</span>
                    <span class="report-val" id="resDate">-</span>
                </div>
                <div class="report-row" style="border:none;">
                    <span class="report-label">Ø§Ù…ØªÛŒØ§Ø² Ù†Ù‡Ø§ÛŒÛŒ:</span>
                </div>
                <div class="score-big" id="resScore">Û°</div>
            </div>

            <p style="font-family:'Vazirmatn'; font-size:0.8rem; color:#aaa;">Ø¢Ø²Ù…ÙˆÙ† Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯Ù‡ Ø§Ø³Øª.</p>
            
            <button class="admin-btn" onclick="adminReset()">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
        </div>
    </div>

    <div id="game-ui" style="display:none;">
        <div class="timer-box">
            <span class="timer-icon">â±</span>
            <span id="timerEl">05:00</span>
        </div>
        <div class="badge"><span>ğŸš€</span> <span style="font-family:'Vazirmatn'; font-size:0.8rem;">Ú©Ù„Ø§Ø³ Ù¾Ù†Ø¬Ù…</span></div>
        
        <div class="hud-top">
            <span id="scoreEl">Ø§Ù…ØªÛŒØ§Ø²: Û°</span>
            <div style="width:1px; height:20px; background:#fff;"></div>
            <div id="problemEl" class="math-problem"></div>
        </div>
        
        <div id="feedback" class="feedback-overlay">
            <span class="fb-text" id="fbText">Ø¢ÙØ±ÛŒÙ†!</span>
            <span class="fb-sub" id="fbSub">Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­ Ø¨ÙˆØ¯</span>
        </div>

        <button id="btn-shoot">Ø´Ú©Ø§Ø±Ø´ Ú©Ù†!</button>
    </div>

    <script>
        const DB_KEY = 'chamran_final_v3.5';
        const toPersianNum = (n) => n.toString().replace(/\d/g, x => "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹"[x]);
        const $ = (id) => document.getElementById(id);

        // --- Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø± ---
        function checkUserStatus() {
            const savedData = localStorage.getItem(DB_KEY);
            if (savedData) {
                // Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ØŒ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ø±ÙˆØ¯ Ø¨Ù‡ Ú©Ø§Ø±Ù†Ø§Ù…Ù‡
                const data = JSON.parse(savedData);
                showResult(data.name, data.score, data.date);
            } else {
                $('login-screen').classList.add('active');
            }
        }

        // Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ù†Ø§Ù…Ù‡
        function showResult(name, score, date) {
            $('resName').innerText = name;
            $('resScore').innerText = toPersianNum(score);
            $('resDate').innerText = date ? toPersianNum(date) : toPersianNum(new Date().toLocaleDateString('fa-IR'));
            
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            $('result-screen').classList.add('active');
        }

        // --- Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ ---
        let playerName = "";
        let timerInterval;
        let timeLeft = 300; // 5 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ù‡ Ø«Ø§Ù†ÛŒÙ‡

        function attemptLogin() {
            const name = $('inpName').value.trim();
            if (name.length < 3) { alert("Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª!"); return; }
            playerName = name;
            
            // Ù‚ÙÙ„ Ú©Ø±Ø¯Ù† Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ (Ø«Ø¨Øª Ù†Ø§Ù… Ø§ÙˆÙ„ÛŒÙ‡)
            saveData(0, false); // false ÛŒØ¹Ù†ÛŒ Ù‡Ù†ÙˆØ² ØªÙ…Ø§Ù… Ù†Ø´Ø¯Ù‡ Ø§Ù…Ø§ Ù‚ÙÙ„ Ø§Ø³Øª

            $('login-screen').classList.remove('active');
            $('game-ui').style.display = 'flex';
            
            initGame();
            startTimer();
        }

        function startTimer() {
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    finishGame(true); // ØªÙ…Ø§Ù… Ø´Ø¯Ù† ÙˆÙ‚Øª
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            $('timerEl').innerText = toPersianNum(`${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`);
            if(timeLeft < 30) $('timerEl').style.color = "#ff1744"; // Ù‡Ø´Ø¯Ø§Ø± Ù‚Ø±Ù…Ø²
        }

        function finishGame(timeUp = false) {
            clearInterval(timerInterval);
            if(timeUp) alert("â° ÙˆÙ‚Øª ØªÙ…Ø§Ù… Ø´Ø¯!");
            
            // Ø°Ø®ÛŒØ±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
            const date = new Date().toLocaleDateString('fa-IR');
            saveData(score, true, date);
            
            $('game-ui').style.display = 'none';
            showResult(playerName, score, date);
        }

        function saveData(scr, finished, date="") {
            const data = { name: playerName, score: scr, finished: finished, date: date };
            localStorage.setItem(DB_KEY, JSON.stringify(data));
        }

        // --- Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ù…Ø¹Ù„Ù… (Admin Reset) ---
        function adminReset() {
            const pass = prompt("Ø±Ù…Ø² Ù…Ø¯ÛŒØ±ÛŒØª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:");
            if (pass === "7563") {
                localStorage.removeItem(DB_KEY);
                alert("Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø±ÛŒØ³Øª Ø´Ø¯. Ø§Ú©Ù†ÙˆÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.");
                location.reload();
            } else if (pass) {
                alert("Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.");
            }
        }

        // ================= GAME ENGINE =================
        const canvas = $('gameCanvas'); const ctx = canvas.getContext('2d');
        const bgCanvas = $('bgCanvas'); const bgCtx = bgCanvas.getContext('2d');
        let width, height;
        const resize = () => { width=window.innerWidth; height=window.innerHeight; canvas.width=bgCanvas.width=width; canvas.height=bgCanvas.height=height; };
        window.addEventListener('resize', resize); resize();

        let orbs=[], particles=[], stars=[], score=0, currentProblem={}, qCount=0;
        const MAX_Q = 10; // ØªØ¹Ø¯Ø§Ø¯ Ø³ÙˆØ§Ù„Ø§Øª

        class Star { constructor(){this.x=Math.random()*width;this.y=Math.random()*height;this.s=Math.random()*2;} draw(){bgCtx.fillStyle=`rgba(255,255,255,${Math.random()})`;bgCtx.beginPath();bgCtx.arc(this.x,this.y,this.s,0,6.28);bgCtx.fill();} }
        class Orb { constructor(x,y){this.x=x;this.y=y;this.r=0;this.tr=width<600?28:35;this.vx=(Math.random()-0.5)*2;this.vy=(Math.random()-0.5)*2;this.sel=false;} update(){this.x+=this.vx;this.y+=this.vy;if(this.x<this.tr||this.x>width-this.tr)this.vx*=-1;if(this.y<this.tr+100||this.y>height-this.tr-80)this.vy*=-1;if(this.r<this.tr)this.r+=2;} draw(){ctx.beginPath();ctx.arc(this.x,this.y,this.r,0,6.28);ctx.fillStyle=this.sel?'#ffd700':'rgba(0,242,255,0.2)';ctx.fill();ctx.lineWidth=2;ctx.strokeStyle=this.sel?'#fff':'rgba(0,242,255,0.8)';ctx.stroke();if(this.sel){ctx.shadowBlur=20;ctx.shadowColor='#ffd700';}else{ctx.shadowBlur=0;}} }
        class Part { constructor(x,y,c){this.x=x;this.y=y;this.c=c;this.vx=(Math.random()-0.5)*10;this.vy=(Math.random()-0.5)*10;this.l=1;} up(){this.x+=this.vx;this.y+=this.vy;this.l-=0.05;} dr(){ctx.globalAlpha=this.l;ctx.fillStyle=this.c;ctx.beginPath();ctx.arc(this.x,this.y,4,0,6.28);ctx.fill();ctx.globalAlpha=1;} }

        function initGame() { for(let i=0;i<60;i++)stars.push(new Star()); genQ(); loop(); }
        function genQ() {
            if(qCount>=MAX_Q){ finishGame(); return; } qCount++;
            const den=[2,3,4,5], d=den[Math.floor(Math.random()*den.length)], n=Math.floor(Math.random()*(d-1))+1, w=d*(Math.floor(Math.random()*2)+1), ans=(w/d)*n;
            currentProblem={ans};
            const fH=`<div class="fraction"><span>${toPersianNum(n)}</span><div class="frac-line"></div><span>${toPersianNum(d)}</span></div>`, wH=`<span>${toPersianNum(w)}</span>`;
            $('problemEl').innerHTML = Math.random()>0.5 ? `${fH} <span>Ã—</span> ${wH} <span>=</span> ?` : `${wH} <span>Ã—</span> ${fH} <span>=</span> ?`;
            $('btn-shoot').classList.remove('show');
            orbs=[]; for(let i=0;i<w;i++) orbs.push(new Orb(width/2, height/2));
        }
        
        // --- Ø§ÙÚ©Øª Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡) ---
        function showFeedback(type) {
            const fb = $('feedback');
            const txt = $('fbText');
            const sub = $('fbSub');
            
            fb.classList.remove('show');
            void fb.offsetWidth; // Ø±ÛŒØ³Øª Ø§Ù†ÛŒÙ…ÛŒØ´Ù†
            
            if(type === 'success') {
                txt.innerText = "Ø¢ÙØ±ÛŒÙ†!"; txt.style.color = "#00e676";
                sub.innerText = "Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­ Ø¨ÙˆØ¯"; sub.style.color = "#fff";
                if(navigator.vibrate) navigator.vibrate(100); // ÙˆÛŒØ¨Ø±Ù‡
            } else {
                txt.innerText = "Ø¯Ù‚Øª Ú©Ù†!"; txt.style.color = "#ff1744";
                sub.innerText = "Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯ÛŒ"; sub.style.color = "#ffcdd2";
                if(navigator.vibrate) navigator.vibrate([50, 50, 50]); // ÙˆÛŒØ¨Ø±Ù‡ ØºÙ„Ø·
            }
            
            fb.classList.add('show');
            setTimeout(() => fb.classList.remove('show'), 1200);
        }

        function checkAns() {
            const s = orbs.filter(o=>o.sel).length;
            if(s===currentProblem.ans) { 
                score+=20; $('scoreEl').innerText=`Ø§Ù…ØªÛŒØ§Ø²: ${toPersianNum(score)}`; 
                showFeedback('success');
                orbs.forEach(o=>{if(o.sel)for(let k=0;k<8;k++)particles.push(new Part(o.x,o.y,'#ffd700'))}); orbs=[]; 
                setTimeout(genQ, 1500); 
            } else { 
                showFeedback('error');
            }
        }
        function loop() {
            bgCtx.clearRect(0,0,width,height); stars.forEach(s=>s.draw()); ctx.clearRect(0,0,width,height);
            const sels=orbs.filter(o=>o.sel); ctx.beginPath(); ctx.strokeStyle='rgba(255,235,59,0.5)'; ctx.lineWidth=2;
            for(let i=0;i<sels.length;i++)for(let j=i+1;j<sels.length;j++)if(Math.hypot(sels[i].x-sels[j].x,sels[i].y-sels[j].y)<250){ctx.moveTo(sels[i].x,sels[i].y);ctx.lineTo(sels[j].x,sels[j].y);} ctx.stroke();
            orbs.forEach(o=>{o.update();o.draw()}); particles.forEach((p,i)=>{p.up();p.dr();if(p.l<=0)particles.splice(i,1)}); requestAnimationFrame(loop);
        }
        function handle(x,y) {
            let ch=false; orbs.forEach(o=>{if(Math.hypot(x-o.x,y-o.y)<o.tr+15){o.sel=!o.sel;ch=true;for(let k=0;k<3;k++)particles.push(new Part(o.x,o.y,'#fff'))}});
            if(ch){const c=orbs.filter(o=>o.sel).length, b=$('btn-shoot'); if(c>0){b.classList.add('show');b.innerText=`Ø´Ú©Ø§Ø± ${toPersianNum(c)} Ù‡Ø¯Ù`;}else b.classList.remove('show');}
        }
        canvas.addEventListener('mousedown',e=>handle(e.clientX,e.clientY));
        canvas.addEventListener('touchstart',e=>{e.preventDefault();handle(e.changedTouches[0].clientX,e.changedTouches[0].clientY)},{passive:false});
        $('btn-shoot').addEventListener('click',checkAns); $('btn-shoot').addEventListener('touchstart',e=>{e.preventDefault();checkAns()});
        
        checkUserStatus();
    </script>
</body>
</html>
