<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¢Ø²Ù…ÙˆÙ† Ø±ÛŒØ§Ø¶ÛŒ Ú†Ù…Ø±Ø§Ù† (ÙˆØ±ÙˆØ¯ ÛŒÚ©Ø¨Ø§Ø±)</title>
    
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/lalezar-font@v32.0/dist/lalezar-font-face.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />

    <style>
        :root { --primary: #00f2ff; --bg: #050510; --accent: #ff0055; }
        body { margin: 0; overflow: hidden; background: var(--bg); color: #fff; font-family: 'Lalezar'; touch-action: none; user-select: none; }
        
        .screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; background: var(--bg); transition: opacity 0.5s;
        }
        .active { display: flex; }

        .login-box {
            background: rgba(255,255,255,0.05); padding: 30px; border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1); width: 85%; max-width: 350px;
            text-align: center; backdrop-filter: blur(10px);
        }
        input {
            width: 100%; padding: 15px; margin: 20px 0; border-radius: 50px;
            border: 2px solid #333; background: #000; color: #fff;
            font-family: 'Vazirmatn'; text-align: center; font-size: 1.1rem; outline: none;
            box-sizing: border-box; 
        }
        button {
            padding: 15px 40px; border-radius: 50px; border: none;
            font-family: 'Lalezar'; font-size: 1.4rem; cursor: pointer;
            background: linear-gradient(45deg, var(--primary), #0066ff); color: #000;
            width: 100%; box-shadow: 0 0 20px rgba(0, 242, 255, 0.4);
        }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ù‚ÙÙ„ */
        .lock-icon { font-size: 4rem; margin-bottom: 10px; animation: shake 0.5s; }
        @keyframes shake { 0%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} 100%{transform:translateX(0)} }

        /* Ù…Ø­ÛŒØ· Ø¨Ø§Ø²ÛŒ */
        #game-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: flex; flex-direction: column; align-items: center; }
        .hud-top { margin-top: 60px; background: rgba(255,255,255,0.1); padding: 10px 30px; border-radius: 20px; backdrop-filter: blur(5px); pointer-events: auto; display: flex; gap: 20px; align-items: center; border: 1px solid rgba(255,255,255,0.2); }
        .math-problem { font-size: 2.2rem; direction: ltr; display: flex; align-items: center; gap: 10px; color: #ffeb3b; }
        .fraction { display: inline-flex; flex-direction: column; align-items: center; font-size: 0.8em; line-height: 1; }
        .frac-line { width: 100%; height: 2px; background: currentColor; margin: 3px 0; }
        #btn-shoot { position: absolute; bottom: 40px; width: 200px; background: #00e676; box-shadow: 0 0 20px #00e676; opacity: 0; transform: scale(0); pointer-events: auto; transition: all 0.3s; }
        #btn-shoot.show { opacity: 1; transform: scale(1); }
        .feedback { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 5rem; text-shadow: 0 0 30px #fff; display: none; z-index: 50; }
        .badge { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.7); padding: 5px 15px; border-radius: 20px; border: 1px solid var(--accent); display: flex; align-items: center; gap: 8px; z-index: 20; }

    </style>
</head>
<body>

    <canvas id="bgCanvas" style="position:absolute; top:0; left:0; z-index:0;"></canvas>
    <canvas id="gameCanvas" style="position:absolute; top:0; left:0; z-index:1;"></canvas>

    <div id="login-screen" class="screen">
        <div class="login-box">
            <h1 style="margin:0; color:var(--primary);">Ú©Ù„Ø§Ø³ Ø´Ù‡ÛŒØ¯ Ú†Ù…Ø±Ø§Ù†</h1>
            <p style="font-family:'Vazirmatn'; font-size:0.9rem;">Ø¢Ø²Ù…ÙˆÙ† Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø±ÛŒØ§Ø¶ÛŒ (ÙÙ‚Ø· ÛŒÚ©â€ŒØ¨Ø§Ø± ÙØ±ØµØª Ø¯Ø§Ø±ÛŒØ¯)</p>
            <input type="text" id="inpName" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ..." autocomplete="off">
            <button onclick="attemptLogin()">Ø´Ø±ÙˆØ¹ Ø¢Ø²Ù…ÙˆÙ†</button>
        </div>
    </div>

    <div id="lock-screen" class="screen">
        <div class="login-box" style="border-color:var(--accent);">
            <div class="lock-icon">â›”</div>
            <h2 style="margin:0;">Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø³ØªÙ‡ Ø´Ø¯</h2>
            <p style="color:#fff; font-size:1.2rem; margin:10px 0;" id="lockName">-</p>
            <p style="font-family:'Vazirmatn'; font-size:0.9rem; color:#aaa;">
                Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ§Ø±Ø¯ Ø¢Ø²Ù…ÙˆÙ† Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯.<br>Ø§Ù…Ú©Ø§Ù† ÙˆØ±ÙˆØ¯ Ù…Ø¬Ø¯Ø¯ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.
            </p>
            <div id="prevScore" style="margin-top:20px; color:#ffeb3b; font-size:1.2rem;"></div>
        </div>
    </div>

    <div id="game-ui" style="display:none;">
        <div class="badge"><span>ğŸš€</span> <span style="font-family:'Vazirmatn'; font-size:0.8rem;">Ú©Ù„Ø§Ø³ Ù¾Ù†Ø¬Ù…</span></div>
        <div class="hud-top">
            <span id="scoreEl">Ø§Ù…ØªÛŒØ§Ø²: Û°</span>
            <div style="width:1px; height:20px; background:#fff;"></div>
            <div id="problemEl" class="math-problem"></div>
        </div>
        <div id="feedback" class="feedback"></div>
        <button id="btn-shoot">Ø´Ú©Ø§Ø±Ø´ Ú©Ù†!</button>
    </div>

    <div id="result-screen" class="screen">
        <div class="login-box" style="border-color:#00e676;">
            <h1 style="color:#00e676;">Ù¾Ø§ÛŒØ§Ù† Ø¢Ø²Ù…ÙˆÙ†</h1>
            <p style="color:#fff; font-size:1.5rem;" id="finalName">-</p>
            <p>Ø§Ù…ØªÛŒØ§Ø² Ù†Ù‡Ø§ÛŒÛŒ:</p>
            <h2 style="font-size:3rem; margin:0; color:#ffeb3b;" id="finalScore">Û°</h2>
            <p style="font-size:0.8rem; margin-top:20px;">Ù†ØªÛŒØ¬Ù‡ Ø«Ø¨Øª Ø´Ø¯. Ø®Ø±ÙˆØ¬ Ù…Ù…Ù†ÙˆØ¹.</p>
        </div>
    </div>

    <script>
        // --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‚ÙÙ„ Ù‡ÙˆØ´Ù…Ù†Ø¯ ---
        const DB_KEY = 'chamran_strict_lock_v2'; // Ú©Ù„ÛŒØ¯ Ø°Ø®ÛŒØ±Ù‡ Ø³Ø§Ø²ÛŒ
        const toPersianNum = (n) => n.toString().replace(/\d/g, x => "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹"[x]);
        const $ = (id) => document.getElementById(id);

        // Û±. Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¯Ø± Ù„Ø­Ø¸Ù‡ Ø¨Ø§Ø² Ø´Ø¯Ù† Ø³Ø§ÛŒØª
        function checkUserStatus() {
            const savedData = localStorage.getItem(DB_KEY);
            if (savedData) {
                // Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ú©Ù…Ù‡ Ø´Ø±ÙˆØ¹ Ø±Ø§ Ø²Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡ Ù‚ÙÙ„ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                const data = JSON.parse(savedData);
                showLockedScreen(data.name, data.score);
            } else {
                $('login-screen').classList.add('active');
            }
        }

        function showLockedScreen(name, score) {
            $('lockName').innerText = name;
            if(score !== undefined) {
                $('prevScore').innerText = `Ø¢Ø®Ø±ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø² Ø«Ø¨Øª Ø´Ø¯Ù‡: ${toPersianNum(score)}`;
            }
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            $('lock-screen').classList.add('active');
        }

        // Û². ØªØ§Ø¨Ø¹ ÙˆØ±ÙˆØ¯ (Ù†Ù‚Ø·Ù‡ Ù…Ù‡Ù…: Ù‚ÙÙ„ Ú©Ø±Ø¯Ù† Ø¯Ø± Ù„Ø­Ø¸Ù‡ ÙˆØ±ÙˆØ¯)
        let playerName = "";
        
        function attemptLogin() {
            const name = $('inpName').value.trim();
            if (name.length < 3) { alert("Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª!"); return; }
            playerName = name;
            
            // *** Ù‚ÙÙ„ Ú©Ø±Ø¯Ù† Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ ***
            // Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù† Ø«Ø¨Øª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ú©Ù‡ Ø§ÛŒÙ† Ú¯ÙˆØ´ÛŒ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ø§Ø³Øª (Ø­ØªÛŒ Ø¨Ø§ Ø§Ù…ØªÛŒØ§Ø² Û°)
            const initialData = { name: playerName, score: 0, status: 'started' };
            localStorage.setItem(DB_KEY, JSON.stringify(initialData));

            // Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ
            $('login-screen').classList.remove('active');
            $('game-ui').style.display = 'flex';
            initGame();
        }

        // Û³. Ø°Ø®ÛŒØ±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ (Ø¢Ù¾Ø¯ÛŒØª Ø§Ù…ØªÛŒØ§Ø²)
        function finishGame() {
            const data = { name: playerName, score: score, status: 'finished' };
            localStorage.setItem(DB_KEY, JSON.stringify(data)); // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ù…ØªÛŒØ§Ø² Ù†Ù‡Ø§ÛŒÛŒ

            $('finalName').innerText = playerName;
            $('finalScore').innerText = toPersianNum(score);
            $('game-ui').style.display = 'none';
            $('result-screen').classList.add('active');
        }

        // --- Ù…ÙˆØªÙˆØ± Ø¨Ø§Ø²ÛŒ ---
        const canvas = $('gameCanvas'); const ctx = canvas.getContext('2d');
        const bgCanvas = $('bgCanvas'); const bgCtx = bgCanvas.getContext('2d');
        let width, height;
        const resize = () => { width=window.innerWidth; height=window.innerHeight; canvas.width=bgCanvas.width=width; canvas.height=bgCanvas.height=height; };
        window.addEventListener('resize', resize); resize();

        let orbs=[], particles=[], stars=[], score=0, currentProblem={}, qCount=0;
        const MAX_Q = 5; // ØªØ¹Ø¯Ø§Ø¯ Ø³ÙˆØ§Ù„Ø§Øª

        class Star { constructor(){this.x=Math.random()*width;this.y=Math.random()*height;this.s=Math.random()*2;} draw(){bgCtx.fillStyle='rgba(255,255,255,0.5)';bgCtx.beginPath();bgCtx.arc(this.x,this.y,this.s,0,6.28);bgCtx.fill();} }
        class Orb { constructor(x,y){this.x=x;this.y=y;this.r=0;this.tr=width<600?28:35;this.vx=(Math.random()-0.5)*2;this.vy=(Math.random()-0.5)*2;this.sel=false;} update(){this.x+=this.vx;this.y+=this.vy;if(this.x<this.tr||this.x>width-this.tr)this.vx*=-1;if(this.y<this.tr+100||this.y>height-this.tr-80)this.vy*=-1;if(this.r<this.tr)this.r+=2;} draw(){ctx.beginPath();ctx.arc(this.x,this.y,this.r,0,6.28);ctx.fillStyle=this.sel?'#ffd700':'rgba(0,242,255,0.2)';ctx.fill();ctx.lineWidth=2;ctx.strokeStyle=this.sel?'#fff':'rgba(0,242,255,0.8)';ctx.stroke();if(this.sel){ctx.shadowBlur=20;ctx.shadowColor='#ffd700';}else{ctx.shadowBlur=0;}} }
        class Part { constructor(x,y,c){this.x=x;this.y=y;this.c=c;this.vx=(Math.random()-0.5)*10;this.vy=(Math.random()-0.5)*10;this.l=1;} up(){this.x+=this.vx;this.y+=this.vy;this.l-=0.05;} dr(){ctx.globalAlpha=this.l;ctx.fillStyle=this.c;ctx.beginPath();ctx.arc(this.x,this.y,4,0,6.28);ctx.fill();ctx.globalAlpha=1;} }

        function initGame() { for(let i=0;i<60;i++)stars.push(new Star()); genQ(); loop(); }
        function genQ() {
            if(qCount>=MAX_Q){ finishGame(); return; } qCount++;
            const den=[2,3,4,5], d=den[Math.floor(Math.random()*den.length)], n=Math.floor(Math.random()*(d-1))+1, w=d*(Math.floor(Math.random()*2)+1), ans=(w/d)*n;
            currentProblem={ans};
            const fH=`<div class="fraction"><span>${toPersianNum(n)}</span><div class="frac-line"></div><span>${toPersianNum(d)}</span></div>`, wH=`<span>${toPersianNum(w)}</span>`;
            $('problemEl').innerHTML = Math.random()>0.5 ? `${fH} <span>Ã—</span> ${wH} <span>=</span> ?` : `${wH} <span>Ã—</span> ${fH} <span>=</span> ?`;
            $('btn-shoot').classList.remove('show');
            orbs=[]; for(let i=0;i<w;i++) orbs.push(new Orb(width/2, height/2));
        }
        function checkAns() {
            const s = orbs.filter(o=>o.sel).length, fb=$('feedback');
            if(s===currentProblem.ans) { score+=20; $('scoreEl').innerText=`Ø§Ù…ØªÛŒØ§Ø²: ${toPersianNum(score)}`; fb.innerText="âœ…"; fb.style.color="#00e676"; fb.style.display="block"; orbs.forEach(o=>{if(o.sel)for(let k=0;k<5;k++)particles.push(new Part(o.x,o.y,'#ffd700'))}); orbs=[]; setTimeout(()=>{fb.style.display="none"; genQ();},1500); }
            else { fb.innerText="âŒ"; fb.style.color="#ff1744"; fb.style.display="block"; setTimeout(()=>{fb.style.display="none";},1000); }
        }
        function loop() {
            bgCtx.clearRect(0,0,width,height); stars.forEach(s=>s.draw()); ctx.clearRect(0,0,width,height);
            const sels=orbs.filter(o=>o.sel); ctx.beginPath(); ctx.strokeStyle='rgba(255,235,59,0.5)'; ctx.lineWidth=2;
            for(let i=0;i<sels.length;i++)for(let j=i+1;j<sels.length;j++)if(Math.hypot(sels[i].x-sels[j].x,sels[i].y-sels[j].y)<250){ctx.moveTo(sels[i].x,sels[i].y);ctx.lineTo(sels[j].x,sels[j].y);} ctx.stroke();
            orbs.forEach(o=>{o.update();o.draw()}); particles.forEach((p,i)=>{p.up();p.dr();if(p.l<=0)particles.splice(i,1)}); requestAnimationFrame(loop);
        }
        function handle(x,y) {
            let ch=false; orbs.forEach(o=>{if(Math.hypot(x-o.x,y-o.y)<o.tr+15){o.sel=!o.sel;ch=true;for(let k=0;k<3;k++)particles.push(new Part(o.x,o.y,'#fff'))}});
            if(ch){const c=orbs.filter(o=>o.sel).length, b=$('btn-shoot'); if(c>0){b.classList.add('show');b.innerText=`Ø´Ú©Ø§Ø± ${toPersianNum(c)} Ù‡Ø¯Ù`;}else b.classList.remove('show');}
        }
        canvas.addEventListener('mousedown',e=>handle(e.clientX,e.clientY));
        canvas.addEventListener('touchstart',e=>{e.preventDefault();handle(e.changedTouches[0].clientX,e.changedTouches[0].clientY)},{passive:false});
        $('btn-shoot').addEventListener('click',checkAns); $('btn-shoot').addEventListener('touchstart',e=>{e.preventDefault();checkAns()});
        
        // Ø§Ø¬Ø±Ø§
        checkUserStatus();

    </script>
</body>
</html>
